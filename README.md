<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# تشغيل ونشر النظام

## التشغيل محليًا

**المتطلبات:** Node.js

1. تثبيت الاعتمادات: `npm install`
2. إنشاء ملف إعدادات: انسخ `.env.example` إلى `.env.local` وأكمل القيم المطلوبة (بدون رفع الأسرار إلى GitHub).
3. تشغيل الواجهة + الخادم: `npm run dev:all`

الخادم يوفّر مسار صحة: `GET /api/health`

## النشر عبر GitHub + Render (موصى به للباكند)

يُمكن رفع الباكند إلى Render لتفادي مشاكل السماح بالاتصال من الـ IP المحلي.

1. ادفع المشروع إلى GitHub.
2. في Render: أنشئ خدمة "Web Service" عبر الربط بالمستودع.
3. Render يستخدم ملف `render.yaml` تلقائيًا:
   - `buildCommand`: `npm install && npm run build`
   - `startCommand`: `node server/index.js`
   - `healthCheckPath`: `/api/health`
4. أضف متغيرات البيئة في Render (لوحة التحكم):
   - `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `DB_SSL` (إن كان الاتصال يتطلب TLS)
   - `EXTERNAL_API_BASE`, `AUTH_MODE`, إلخ حسب الحاجة.
5. حدّث عنوان الخادم في الواجهة بإضافة `VITE_SERVER_URL` (مثال: `https://attendance-backend.onrender.com`).

### بيانات الدخول الأولية (Bootstrap Login)

- يعتمد تسجيل الدخول أولًا على المستخدمين الموجودين في قاعدة البيانات (`users`). إن وُجد حساب إداري/موظف في القاعدة فسيُستخدم مباشرةً.
- إن لم تكن القاعدة جاهزة أو فارغة، يوجد حسابان مؤقتان عبر متغيرات البيئة:
  - `ADMIN_USERNAME` و`ADMIN_PASSWORD` للحساب الإداري المؤقت.
  - `EMPLOYEE_USERNAME` و`EMPLOYEE_PASSWORD` لحساب موظف مؤقت.
- القيم الافتراضية إن لم تُضبط هي: اسم المستخدم الإداري `admin` وكلمة مرور فارغة (غير آمن). يُنصح بضبط كلمة مرور قوية فورًا في Render.
- بعد تسجيل الدخول بالحساب المؤقت، أنشئ حسابًا إداريًا دائمًا من صفحة “إدارة المستخدمين”، ثم احذف متغيري البيئة للحساب المؤقت وأعد تشغيل الباكند ليصبح الاعتماد على القاعدة فقط.

### ضبط واجهة cPanel لتتصل بالباكند على Render بدون إعادة بناء

لدعم الضبط السريع في cPanel، تمت إضافة ملف `public/config.json` يُنسخ تلقائيًا إلى `dist/` عند البناء. يمكنك تعديل هذا الملف بعد الرفع مباشرة في cPanel:

- المسار: وثائق الموقع للدومين الفرعي (document root)، الملف: `config.json`.
- البنية:

```
{
  "API_BASE": "https://<رابط-خدمة-Render>"
}
```

- الواجهة تقرأ هذا العنوان في وقت التشغيل. إن لم يوجد الملف، ستستخدم قيمة `VITE_SERVER_URL` عند البناء، وإن لم توجد أيضًا ستسقط إلى `http://localhost:4000` (غير مناسب للإنتاج).

كما تمت إضافة ملف `public/.htaccess` لضمان عمل توجيهات SPA على cPanel ومنع عرض الفهارس.

### تقييد CORS في الباكند (اختياري)

يمكنك تعيين `CORS_ORIGIN` في بيئة Render ليقتصر الاستهلاك على أصل الواجهة:

- مثال: `CORS_ORIGIN=http://qcheck.qssun.solar,https://qcheck.qssun.solar`

إن تُرك فارغًا، تكون سياسة CORS مفتوحة كما كانت.

### تمكين الاتصال بقاعدة MySQL في cPanel

1. افتح `Remote MySQL` في cPanel.
2. أضف عنوان الـ IP الخاص بـ Render أو النطاق/النطاقات المسموح بها.
3. تأكد من فتح المنفذ `3306` لدى مزوّد الاستضافة وأن الاتصال الخارجي مسموح.
4. إن كان المزود يفرض SSL، عيّن `DB_SSL=true` في بيئة الباكند.

> ملاحظة: استخدام `%` كوايلد-كارد في `Remote MySQL` قد يكون غير آمن؛ الأفضل إتاحة IPات محددة فقط.

## بناء نسخة الإنتاج محليًا

1. بناء الواجهة: `npm run build`
2. تشغيل الخادم الإنتاجي الذي يقدّم `dist`: `npm run server`

## تكوينات مهمة

- الخادم يقرأ منفذ التشغيل من `PORT` (منصات سحابية) أو `SERVER_PORT` محليًا.
- يوجد مسار صحة: `GET /api/health`.
- CORS افتراضيًا مفتوح أثناء التطوير؛ في الإنتاج يُفضّل تحديد الأصل المسموح.

## ربط جهاز البصمة ZKTeco

يوفر النظام طريقتين للتعامل مع بيانات الحضور:

- من الـ API الخارجي (`EXTERNAL_API_BASE`) عبر مصادقة Basic/JWT.
- مباشرةً من جهاز ZKTeco داخل الشبكة المحلية.

### تمكين الموصل (Connector) لجهاز ZKTeco

الموصل يقوم باستيراد سجلات الحضور بشكل دوري وحفظها في قاعدة البيانات. لتمكينه:

- عيّن المتغيرات التالية في بيئة الخادم:
  - `ZK_ENABLED=true`
  - `ZK_HOST=<عنوان-الـIP-للجهاز>`
  - `ZK_PORT=4370` (افتراضي أجهزة ZKTeco)
  - `ZK_INPORT=5200` (افتراضي المكتبة)
  - `ZK_TIMEOUT_MS=5000` (اختياري)
  - `ZK_PASSWORD=<كلمة-مرور-الاتصال>` (إن كانت مفعلة على الجهاز)
  - `ZK_INTERVAL_MS=60000` (فترة السحب الدوري بالميلي ثانية)

متطلبات ضرورية:

- قاعدة بيانات MySQL مفعلة (قم بضبط `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`).
- الخادم يجب أن يكون ضمن نفس الشبكة التي يتواجد فيها الجهاز، أو عبر توجيه منافذ آمن/نفق VPN للوصول إلى `ZK_HOST` من الخادم.

### مسارات API لاختبار الجهاز وسحب بياناته مباشرةً

- `POST /api/device-test`: اختبار الاتصال السريع، يقبل بارامترات الاتصال في الـ body أو يعتمد على البيئة، ويُرجع عدد المستخدمين/السجلات إن أمكن.
- `POST /api/device-users`: يجلب قائمة المستخدمين مباشرةً من الجهاز بدون الحاجة إلى قاعدة بيانات.
- `POST /api/device-attendances`: يجلب سجلات الحضور من الجهاز (لا يحفظ في قاعدة البيانات؛ الحفظ يتم بواسطة الموصل عند تمكينه).

أمثلة طلبات:

```
POST /api/device-test
{
  "host": "192.168.1.50",
  "port": 4370,
  "inport": 5200,
  "timeout": 5000,
  "password": 0
}
```

> ملاحظة هامة: على منصات مثل Render، عادةً لا يمكن الوصول إلى أجهزة داخل LAN خاصّة بالشركة مباشرةً. يُنصح إما تشغيل الباكند داخل نفس الشبكة، أو إعداد نفق آمن/توجيه منافذ للوصول للجهاز خارجيًا.

### موصل LAN لدفع السجلات إلى الخادم (موصى به لشبكات داخلية)

عندما يتعذّر وصول خادم السحابة إلى جهاز ZKTeco مباشرةً (بدون VPN/Port-Forward)، الحل العملي هو تشغيل موصل خفيف داخل الشبكة الداخلية يقوم بسحب السجلات محليًا ويدفعها للخادم عبر HTTPS.

- لماذا هذا الخيار؟
  - لا يحتاج فتح منافذ الجهاز للعامة.
  - يدفع السجلات دوريًا وآمنًا باستخدام رمز مشترك.

- إعداد الخادم (Render):
  - عيّن متغير البيئة `CONNECTOR_TOKEN` بقيمة سرّية قوية.
  - تأكد من ضبط قاعدة البيانات (`DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `DB_SSL` إن لزم).
  - نقطة الاستقبال: `POST /api/device-push-logs`
    - العنوان: `Authorization: Bearer <CONNECTOR_TOKEN>`
    - الـ body:
      ```json
      {
        "logs": [ { /* سجلّات الجهاز كما تُرجعها node-zklib */ } ]
      }
      ```
    - الخادم يتحقق من الرمز ويُدرج/يُحدّث السجلات في قاعدة البيانات.

- إعداد موصل LAN (داخل الشبكة):
  1. تأكد من وجود Node.js على جهاز ويندوز/لينكس داخل نفس LAN للجهاز.
  2. في المشروع، استخدم السكربت `connector/zk-connector.js`.
  3. أنشئ ملف `.env` بجانب السكربت أو في جذر المشروع بالقيم التالية:
     ```env
     API_BASE=https://attendance-backend-u99p.onrender.com
     CONNECTOR_TOKEN=<نفس-القيمة-المعيّنة-على-الخادم>
     ZK_HOST=192.168.1.50
     ZK_PORT=4370
     ZK_INPORT=5200
     ZK_TIMEOUT_MS=5000
     ZK_PASSWORD=
     ZK_INTERVAL_MS=60000
     ```
  4. ثبّت الاعتمادات إن لم تكن مثبّتة: `npm install`
  5. شغّل الموصل: `node connector/zk-connector.js`

- ما الذي سترى؟
  - سحب دوري للسجلات من الجهاز، ثم طلب `POST` إلى الخادم.
  - عند النجاح: `Push ok:`؛ عند الفشل ستظهر الحالة والسبب.

- نصائح أمان وتشغيل:
  - احفظ `CONNECTOR_TOKEN` بسرّية ولا تشاركه خارج النظام.
  - اضبط `ZK_INTERVAL_MS` بحسب تكرار المزامنة المطلوب.
  - تأكد أن الجهاز يمكن الوصول إليه من جهاز الموصل (Ping/Firewall).
